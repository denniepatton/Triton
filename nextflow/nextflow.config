nextflow.enable.dsl = 2

/*
 * Keep this workflow self-contained under nf/.
 * Run from repo root:
 *   nextflow run nf -profile docker
 */

params {
  // Reuse existing Triton configs
  samples_yaml = "${projectDir}/../config/samples.yaml"
  config_yaml  = "${projectDir}/../config/config.yaml"
  config_dir   = "${projectDir}/../config"

  // Where to publish final outputs (mirrors Snakemake default results/)
  outdir = "${projectDir}/../results"

  // triton_cleanup.py output_format: 'long' (default) or 'wide'
  output_format = 'long'

  // Container image reference (set this once you publish)
  container = 'ghcr.io/denniepatton/triton:dev'

  // Optional bind paths for Singularity/Apptainer, e.g. '/fh,/hpc,/scratch'
  bind_paths = ''

  // Optional Slurm queue/partition
  queue = null
}

def dockerImageUri = params.container
def ociImageUri = params.container?.startsWith('docker://') ? params.container : "docker://${params.container}"

process {
  shell = ['/bin/bash', '-euo', 'pipefail']
  stageInMode = 'symlink'

  // Reasonable defaults; override via profiles or -process.* CLI if needed.
  cpus = 4
  memory = '16 GB'
  time = '24h'

  errorStrategy = 'retry'
  maxRetries = 1
}

profiles {
  local {
    process.executor = 'local'
  }

  docker {
    docker.enabled = true
    process.container = dockerImageUri
  }

  singularity {
    singularity.enabled = true
    singularity.autoMounts = true
    singularity.cacheDir = "${System.properties['user.home']}/.singularity"
    singularity.runOptions = params.bind_paths ? "-B ${params.bind_paths}" : ''
    process.container = ociImageUri
  }

  apptainer {
    apptainer.enabled = true
    apptainer.autoMounts = true
    apptainer.cacheDir = "${System.properties['user.home']}/.apptainer"
    apptainer.runOptions = params.bind_paths ? "-B ${params.bind_paths}" : ''
    process.container = ociImageUri
  }

  slurm {
    process.executor = 'slurm'
    if( params.queue ) process.queue = params.queue
  }

  slurm_singularity {
    process.executor = 'slurm'
    if( params.queue ) process.queue = params.queue

    singularity.enabled = true
    singularity.autoMounts = true
    singularity.cacheDir = "${System.properties['user.home']}/.singularity"
    singularity.runOptions = params.bind_paths ? "-B ${params.bind_paths}" : ''

    process.container = ociImageUri
  }

  slurm_apptainer {
    process.executor = 'slurm'
    if( params.queue ) process.queue = params.queue

    apptainer.enabled = true
    apptainer.autoMounts = true
    apptainer.cacheDir = "${System.properties['user.home']}/.apptainer"
    apptainer.runOptions = params.bind_paths ? "-B ${params.bind_paths}" : ''

    process.container = ociImageUri
  }
}
